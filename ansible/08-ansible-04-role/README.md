# Домашнее задание к занятию 4 «Работа с roles»

## Подготовка к выполнению

1. * Необязательно. Познакомьтесь с [LightHouse](https://youtu.be/ymlrNlaHzIY?t=929).
2. Создайте два пустых публичных репозитория в любом своём проекте: vector-role и lighthouse-role.
3. Добавьте публичную часть своего ключа к своему профилю на GitHub.

## Основная часть

Ваша цель — разбить ваш playbook на отдельные roles. 

Задача — сделать roles для ClickHouse, Vector и LightHouse и написать playbook для использования этих ролей. 

Ожидаемый результат — существуют три ваших репозитория: два с roles и один с playbook.

**Что нужно сделать**

1. Создайте в старой версии playbook файл `requirements.yml` и заполните его содержимым:

   ```yaml
   ---
     - src: git@github.com:AlexeySetevoi/ansible-clickhouse.git
       scm: git
       version: "1.11.0"
       name: clickhouse 
   ```

2. При помощи `ansible-galaxy` скачайте себе эту роль.
```
ansible-galaxy install -r requirements.yml -p roles
Starting galaxy role install process
- clickhouse (1.11.0) is already installed, skipping.
```

3. Создайте новый каталог с ролью при помощи `ansible-galaxy role init vector-role`.
4. На основе tasks из старого playbook заполните новую role. Разнесите переменные между `vars` и `default`. 
5. Перенести нужные шаблоны конфигов в `templates`.
6. Опишите в `README.md` обе роли и их параметры.
7. Повторите шаги 3–6 для LightHouse. Помните, что одна роль должна настраивать один продукт.
8. Выложите все roles в репозитории. Проставьте теги, используя семантическую нумерацию. Добавьте roles в `requirements.yml` в playbook. 
```
 cat requirements.yml
---
 - src: git@github.com:AlexeySetevoi/ansible-clickhouse.git
   scm: git
   version: "1.11.0"
   name: clickhouse

 - src: git@github.com:Igor-99/vector-role.git
   scm: git
   version: "1.1.0"
   name: vector

 - src: git@github.com:Igor-99/lighthouse-role.git
   scm: git
   version: "1.1.0"
   name: lighthouse

ansible-galaxy install -r requirements.yml -p roles
Starting galaxy role install process
- clickhouse (1.11.0) is already installed, skipping.
- vector (1.1.0) is already installed, skipping.
- lighthouse (1.1.0) is already installed, skipping.
```
9. Переработайте playbook на использование roles. Не забудьте про зависимости LightHouse и возможности совмещения `roles` с `tasks`.
```
---
- name: Install Clickhouse
  hosts: clickhouse
  remote_user: ubuntu
  vars:
    ansible_ssh_private_key_file: "/home/ubuntu/.ssh/id_rsa"
  roles:
    - clickhouse

- name: Install Vector
  hosts: vector
  remote_user: ubuntu
  vars:
    ansible_ssh_private_key_file: "/home/ubuntu/.ssh/id_rsa"
  roles:
    - vector

- name: Install lighthouse
  hosts: lighthouse
  remote_user: ubuntu
  vars:
    ansible_ssh_private_key_file: "/home/ubuntu/.ssh/id_rsa"
  roles:
    - lighthouse

ansible-playbook -i inventory/prod.yml site.yml

PLAY [Install Clickhouse] *******************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Include OS Family Specific Variables] ************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : include_tasks] ***********************************************************************************************************************************************************************************************************
included: /home/ubuntu/devops-23/ansible/08-ansible-04-role/playbook/roles/clickhouse/tasks/precheck.yml for clickhouse-01

TASK [clickhouse : Requirements check | Checking sse4_2 support] ****************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Requirements check | Not supported distribution && release] **************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : include_tasks] ***********************************************************************************************************************************************************************************************************
included: /home/ubuntu/devops-23/ansible/08-ansible-04-role/playbook/roles/clickhouse/tasks/params.yml for clickhouse-01

TASK [clickhouse : Set clickhouse_service_enable] *******************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Set clickhouse_service_ensure] *******************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : include_tasks] ***********************************************************************************************************************************************************************************************************
included: /home/ubuntu/devops-23/ansible/08-ansible-04-role/playbook/roles/clickhouse/tasks/install/yum.yml for clickhouse-01

TASK [clickhouse : Install by YUM | Ensure clickhouse repo GPG key imported] ****************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Install by YUM | Ensure clickhouse repo installed] ***********************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Install by YUM | Ensure clickhouse package installed (latest)] ***********************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Install by YUM | Ensure clickhouse package installed (version latest)] ***************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : include_tasks] ***********************************************************************************************************************************************************************************************************
included: /home/ubuntu/devops-23/ansible/08-ansible-04-role/playbook/roles/clickhouse/tasks/configure/sys.yml for clickhouse-01

TASK [clickhouse : Check clickhouse config, data and logs] **********************************************************************************************************************************************************************************
ok: [clickhouse-01] => (item=/var/log/clickhouse-server)
ok: [clickhouse-01] => (item=/etc/clickhouse-server)
ok: [clickhouse-01] => (item=/var/lib/clickhouse/tmp/)
ok: [clickhouse-01] => (item=/var/lib/clickhouse/)

TASK [clickhouse : Config | Create config.d folder] *****************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Create users.d folder] ******************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Generate system config] *****************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Generate users config] ******************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Generate remote_servers config] *********************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Config | Generate macros config] *****************************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Config | Generate zookeeper servers config] ******************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Config | Fix interserver_http_port and intersever_https_port collision] **************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : Notify Handlers Now] *****************************************************************************************************************************************************************************************************

TASK [clickhouse : include_tasks] ***********************************************************************************************************************************************************************************************************
included: /home/ubuntu/devops-23/ansible/08-ansible-04-role/playbook/roles/clickhouse/tasks/service.yml for clickhouse-01

TASK [clickhouse : Ensure clickhouse-server.service is enabled: True and state: started] ****************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Wait for Clickhouse Server to Become Ready] ******************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : include_tasks] ***********************************************************************************************************************************************************************************************************
included: /home/ubuntu/devops-23/ansible/08-ansible-04-role/playbook/roles/clickhouse/tasks/configure/db.yml for clickhouse-01

TASK [clickhouse : Set ClickHose Connection String] *****************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Gather list of existing databases] ***************************************************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [clickhouse : Config | Delete database config] *****************************************************************************************************************************************************************************************

TASK [clickhouse : Config | Create database config] *****************************************************************************************************************************************************************************************

TASK [clickhouse : include_tasks] ***********************************************************************************************************************************************************************************************************
included: /home/ubuntu/devops-23/ansible/08-ansible-04-role/playbook/roles/clickhouse/tasks/configure/dict.yml for clickhouse-01

TASK [clickhouse : Config | Generate dictionary config] *************************************************************************************************************************************************************************************
skipping: [clickhouse-01]

TASK [clickhouse : include_tasks] ***********************************************************************************************************************************************************************************************************
skipping: [clickhouse-01]

PLAY [Install Vector] ***********************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************************************************************
ok: [vector-01]

TASK [vector : Vector | Download packages] **************************************************************************************************************************************************************************************************
ok: [vector-01]

TASK [vector : Vector | Install packages] ***************************************************************************************************************************************************************************************************
ok: [vector-01]

TASK [vector : Vector | Apply template] *****************************************************************************************************************************************************************************************************
ok: [vector-01]

TASK [vector : Vector | change systemd unit] ************************************************************************************************************************************************************************************************
ok: [vector-01]

PLAY [Install lighthouse] *******************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [lighthouse : Lighthouse | Install git] ************************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [lighthouse : Lighhouse | Install nginx] ***********************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [lighthouse : Lighthouse | Apply nginx config] *****************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [lighthouse : Lighthouse | Clone repository] *******************************************************************************************************************************************************************************************
ok: [lighthouse-01]

TASK [lighthouse : Lighthouse | Apply config] ***********************************************************************************************************************************************************************************************
ok: [lighthouse-01]

PLAY RECAP **********************************************************************************************************************************************************************************************************************************
clickhouse-01              : ok=24   changed=0    unreachable=0    failed=0    skipped=10   rescued=0    ignored=0
lighthouse-01              : ok=6    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
vector-01                  : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

10. Выложите playbook в репозиторий.
11. В ответе дайте ссылки на оба репозитория с roles и одну ссылку на репозиторий с playbook.
Ответ:

[vector-role](https://github.com/Igor-99/vector-role) <br></p>
[lighthouse-role](https://github.com/Igor-99/lighthouse-role) <br></p>
[08-ansible-04-role](https://github.com/Igor-99/devops-23/tree/main/ansible/08-ansible-04-role/playbook) <br></p>

---

### Как оформить решение задания

Выполненное домашнее задание пришлите в виде ссылки на .md-файл в вашем репозитории.

---
